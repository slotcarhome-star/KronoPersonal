<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCX V.2.3</title>
    
    <!-- METADATOS PWA Y PERMISOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SCX V.2.3">
    <meta name="application-name" content="SCX V.2.3">
    <meta http-equiv="Permissions-Policy" content="camera=(self)">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        
        window.initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not available. Running in local mode.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };
        window.initFirebase();
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            color: #e2e8f0; 
            overscroll-behavior: none;
        }
        
        .traffic-light-container.five-lights {
            display: flex;
            gap: 10px;
        }

        .light {
            width: 30px; 
            height: 30px;
            border-radius: 50%;
            background-color: #334155; 
            border: 2px solid #475569; 
            transition: background-color 0.1s ease, box-shadow 0.1s ease;
        }
        .light.red {
            background-color: #ef4444; 
            box-shadow: 0 0 15px #ef4444;
        }
        .light.green {
            background-color: #10b981; 
            box-shadow: 0 0 15px #10b981;
        }

        .neon-text-cyan {
            text-shadow: 0 0 5px #06b6d4, 0 0 10px #06b6d4, 0 0 20px #06b6d4, 0 0 40px rgba(6, 182, 212, 0.4);
        }
        
        .neon-border-box {
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3), inset 0 0 20px rgba(6, 182, 212, 0.05);
            border: 1px solid #06b6d4;
        }

        #video-container {
            position: relative;
            width: 100%; 
            border: 2px solid #475569; 
            background-color: #000; 
            border-radius: 0.5rem; 
            overflow: hidden; 
        }
        
        #webcam-feed {
            max-height: 320px;
            object-fit: cover; 
            width: 100%;
            display: block; 
            transform: scaleX(1);
        }

        #movable-rectangle {
            position: absolute;
            top: 25%; 
            left: 25%;
            width: 50%; 
            height: 50%;
            cursor: grab;
            border: 3px dashed rgba(6, 182, 212, 0.9); 
            background-color: rgba(6, 182, 212, 0.1); 
            box-shadow: 0 0 5px rgba(6, 182, 212, 0.7);
            transition: background-color 0.1s ease, border-color 0.1s ease; 
            z-index: 10; 
            box-sizing: border-box; 
            touch-action: none; 
            display: block; 
        }
        
        .roi-detected {
            background-color: rgba(239, 68, 68, 0.6) !important; 
            border-color: #ef4444 !important;
            box-shadow: 0 0 15px #ef4444 !important;
        }

        .resize-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #06b6d4; 
            border: 3px solid #0f172a; 
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.9);
            touch-action: none; 
            padding: 8px;
            box-sizing: content-box;
        }

        #handle-tl { top: -12px; left: -12px; cursor: nwse-resize; } 
        #handle-br { bottom: -12px; right: -12px; cursor: nwse-resize; } 
        
        .dragging { cursor: grabbing !important; }
        .resizing-nwse { cursor: nwse-resize !important; }

        #video-canvas { display: none; }

        .timer-value {
            font-size: 1.25rem; 
            line-height: 1.75rem; 
            white-space: nowrap;
        }
        @media (min-width: 640px) {
            .timer-value {
                font-size: 1.5rem; 
                line-height: 2rem; 
            }
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; 
        }
        .telemetry-item {
            display: flex;
            flex-direction: column;
            padding: 8px;
            border-radius: 6px;
            background-color: #1e293b; 
        }
        .telemetry-label {
            font-size: 0.75rem; 
            font-weight: 500;
            color: #94a3b8; 
            margin-bottom: 2px;
        }
        .telemetry-data {
            font-size: 0.9rem; 
            font-weight: 700;
            color: #cbd5e1; 
        }
        .telemetry-data.green { color: #34d399; }
        .telemetry-data.yellow { color: #facc15; }
        .telemetry-data.cyan { color: #22d3ee; }

        #config-panel {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-20px);
        }

        #config-panel.open {
            max-height: 1000px; 
            opacity: 1;
            transform: translateY(0);
            padding: 16px;
            margin-top: 16px;
        }
        
        .race-control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 0; 
            border-radius: 12px;
            background-color: #1e293b; 
            border: 1px solid #334155;
            transition: all 0.2s ease;
            font-size: 0.75rem; 
            font-weight: 600;
            color: #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
        }
        
        #start-race-btn.race-control-btn { color: #10b981; }
        #start-race-btn.race-control-btn:hover:not(:disabled) {
            background-color: #10b981;
            color: #0f172a;
            border-color: #059669;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }
        
        #reset-race-btn.race-control-btn { color: #ef4444; }
        #reset-race-btn.race-control-btn:hover:not(:disabled) {
            background-color: #ef4444;
            color: #0f172a;
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        #central-config-btn {
            background-color: rgba(71, 85, 105, 0.7); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 
                        0 4px 6px -4px rgba(0, 0, 0, 0.3), 
                        0 0 15px rgba(6, 182, 212, 0.3); 
            color: #06b6d4; 
            border: 1px solid rgba(100, 116, 139, 0.4); 
            font-weight: 700;
        }
        #central-config-btn:hover:not(:disabled) {
            background-color: rgba(71, 85, 105, 0.9);
            color: #22d3ee;
        }
        
        .control-icon { width: 20px; height: 20px; margin-bottom: 4px; }
        
        @media (max-width: 640px) {
            .light { width: 20px; height: 20px; }
            .traffic-light-container.five-lights { gap: 5px; }
            .header-flex { flex-direction: column; }
            #webcam-feed { max-height: 200px; }
        }
        
        #lap-graph-canvas {
            width: 100%;
            height: 200px; 
            background-color: #1e293b; 
            border-radius: 6px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); 
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #1e293b; 
            color: #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }
        .result-item-label { font-weight: 500; color: #94a3b8; }
        .result-item-data { font-weight: 700; color: #cbd5e1; }
        .result-item-data.best { color: #10b981; font-size: 1.1rem; }

        table {
            width: 100%;
            text-align: left;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #334155;
            font-family: 'monospace';
            font-size: 0.85rem;
        }
        th {
            color: #06b6d4;
            text-transform: uppercase;
            font-weight: 600;
            border-bottom: 2px solid #06b6d4;
        }
        @media (max-width: 400px) {
            th, td { font-size: 0.75rem; padding: 4px; }
        }
        
        #detection-val-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        #record-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: 800;
            border: 2px solid white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }
        #record-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container w-full max-w-3xl mx-auto p-4">

        <div class="flex flex-col sm:flex-row justify-between items-center w-full bg-gray-800 py-3 px-4 rounded-xl shadow-lg mt-4 mb-4 header-flex">
            <div class="flex items-center space-x-4 mb-2 sm:mb-0">
                <h1 class="text-base sm:text-lg font-extrabold text-cyan-400 neon-text-cyan">
                    SCX V.2.3 <span class="text-xs font-normal text-gray-400 ml-1">Race Engineer</span>
                </h1>
                <button id="history-btn" class="text-gray-400 hover:text-white transition-colors p-1 rounded-full hover:bg-gray-700" title="Ver Historial">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>
                </button>
            </div>
            <div id="traffic-light-module" class="traffic-light-container five-lights mt-2 sm:mt-0">
                <div id="light-1" class="light"></div>
                <div id="light-2" class="light"></div>
                <div id="light-3" class="light"></div>
                <div id="light-4" class="light"></div>
                <div id="light-5" class="light"></div>
            </div>
        </div>
        
        <div id="config-panel" class="w-full bg-gray-700 rounded-xl shadow-inner mb-4">
            <h2 class="text-base font-bold text-gray-300 mb-3 border-b border-gray-600 pb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-cog mr-2 text-cyan-400"><path d="M18 21a8 8 0 0 0-8-8c-2 0-4-.5-6-1"/><circle cx="10" cy="8" r="5"/><circle cx="19" cy="18" r="3"/><path d="m19 21-1-1.09c-.38-.41-.58-1.12-.2-1.76l.73-1.22c.26-.43.5-.96.48-1.5-.02-.54-.28-1.03-.76-1.3l-.76-.41c-.48-.26-1.11-.47-1.46-.86-.34-.39-.47-.94-.36-1.45l.23-1.07c.1-.47-.1-.99-.54-1.29l-1.01-.71c-.43-.3-.98-.38-1.5-.23-.52.14-1.13-.1-.95-.62l.33-1.04c.16-.5-.16-1-.59-1.32l-1.1-.98c-.43-.3-.93-.32-1.4-.05-.47.26-1.04.42-1.61.37-.56-.05-1.1-.3-1.37-.73l-.7-1.1c-.26-.43-.5-.96-.48-1.5"/><circle cx="12" cy="12" r="3"/></svg>
                Datos Piloto y Pista
            </h2>
            <div class="space-y-4">
                 <div>
                    <label for="pilot-name-input" class="block text-xs font-medium text-gray-400 mb-1">Nombre del Piloto:</label>
                    <input type="text" id="pilot-name-input" value="Racer 1" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500" />
                </div>
                <div>
                    <label for="car-model-input" class="block text-xs font-medium text-gray-400 mb-1">Modelo del Coche:</label>
                    <input type="text" id="car-model-input" value="Porsche 911" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500" />
                </div>
                <div>
                    <label for="track-length-input" class="block text-xs font-medium text-gray-400 mb-1">Longitud de Pista (Escala 1:1, en metros):</label>
                    <input type="number" id="track-length-input" value="15" min="1" step="0.5" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500" />
                    <p class="text-xs text-gray-500 mt-1">Se usa para calcular la velocidad. Longitud real (a escala 1:1) de la pista.</p>
                </div>
                <div>
                    <label for="lap-limit-select" class="block text-xs font-medium text-gray-400 mb-1 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-infinity mr-1 text-yellow-400"><path d="M12 12c-3.31 0-6 2.69-6 6s2.69 6 6 6"/><path d="M12 12c3.31 0 6-2.69 6-6s-2.69-6-6-6"/></svg>
                        Límite de Vueltas para la Carrera:
                    </label>
                    <select id="lap-limit-select" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="5">5 Vueltas</option>
                        <option value="10" selected>10 Vueltas (Por defecto)</option>
                        <option value="25">25 Vueltas</option>
                        <option value="50">50 Vueltas</option>
                        <option value="Infinity">Infinito (Endurance)</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 mb-4 border-b border-gray-600 pb-2">
                <h2 class="text-base font-bold text-gray-300 flex items-center mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2 mr-2 text-cyan-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    Ajustes de Audio
                </h2>
                
                <div class="flex items-center justify-between mb-4">
                    <label for="voice-toggle" class="text-sm font-medium text-gray-400">Voz Ingeniero de Pista:</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="voice-toggle" id="voice-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                        <label for="voice-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-500 cursor-pointer"></label>
                    </div>
                </div>

                <div class="mb-2">
                    <label for="soundSelect" class="block text-xs font-medium text-gray-400 mb-1">Tono de Vuelta (Beep):</label>
                    <select id="soundSelect" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="0">Beep Clásico (600 Hz)</option>
                        <option value="1">Tono Grave (400 Hz)</option>
                        <option value="2">Beep Agudo (900 Hz)</option>
                        <option value="3">Pito Corto (1200 Hz)</option>
                    </select>
                </div>
            </div>

            <h2 class="text-base font-bold text-gray-300 mt-6 mb-3 border-b border-gray-600 pb-2 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off mr-2 text-green-400"><path d="M10.5 17.5a6.5 6.5 0 0 0 6-6"/><path d="M2 2l20 20"/><path d="M6.5 13.5a6.5 6.5 0 0 1 6-6"/><path d="M22 12c-.5-1.5-2.5-4.5-5.5-5.5"/><path d="M10 12c0 1 1.5 2 3 2s3-1 3-2"/></svg>
                Umbral de Detección (Sensibilidad)
            </h2>
            <label for="threshold-slider" class="block text-sm font-medium text-cyan-400 mb-2">
                Ajustar Umbral
            </label>
            <input type="range" id="threshold-slider" min="0" max="255" value="128" class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>0 (Oscuro)</span>
                <span id="current-threshold" class="font-bold text-yellow-400">128</span>
                <span>255 (Claro)</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">Ajusta esto hasta que el ROI cambie de color cuando el coche cruce la línea.</p>
        </div>
        
        <div class="w-full bg-gray-800 p-4 rounded-xl shadow-lg mb-4 text-center">
            <div class="flex justify-around items-end space-x-4 mb-2">
                <div class="flex-1">
                    <p class="text-xs text-gray-400">TIEMPO CARRERA</p>
                    <p id="race-time" class="timer-value font-mono font-bold text-gray-400">00:00.000</p>
                </div>
                <div class="flex-1 border-l border-gray-700 pl-4">
                    <p class="text-xs text-gray-400">VUELTAS COMPLETADAS</p>
                    <p id="lap-count" class="timer-value font-mono font-bold text-green-400">0 / 10</p> 
                </div>
            </div>
            <p id="lap-time" class="text-sm text-gray-400 mt-2">00.000</p>
        </div>

        <div class="w-full flex space-x-3 mb-4">
            <button id="start-race-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="control-icon text-green-400"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                INICIAR
            </button>
            <button id="central-config-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="control-icon text-cyan-400"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.52a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V22a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.52a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                CONFIG
            </button>
            <button id="reset-race-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="control-icon text-red-400"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                REINICIAR
            </button>
        </div>

        <div id="video-feed-box" class="bg-gray-800 px-4 py-3 rounded-xl shadow-lg w-full mb-4 relative">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-base font-bold text-cyan-400 neon-text-cyan">Video de Pista y ROI</h2>
                <div class="flex space-x-2">
                    <button id="camera-on-btn" class="p-2 rounded-full bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 transition duration-150" aria-label="Encender cámara">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    </button>
                    <button id="camera-off-btn" class="p-2 rounded-full bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 transition duration-150" disabled aria-label="Apagar cámara">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera-off"><path d="M2 2l20 20"/><path d="M4.5 17H4a2 2 0 0 1-2-2v-3h18.5"/><path d="M22 15a2 2 0 0 0-2-2h-1l-2.5-3h-2.5"/><path d="M9.5 4h5L17 7h3a2 2 0 0 1 2 2v1"/><path d="M14.5 17a3 3 0 1 1-5.6-2.5"/></svg>
                    </button>
                </div>
            </div>
            <div id="camera-error-alert" class="hidden bg-red-900 border border-red-700 text-red-100 py-3 rounded-md mb-3" role="alert">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-alert mr-2"><path d="m20 13-8 7-8-7V5l8-4 8 4z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    <span id="camera-error-text" class="block sm:inline font-bold text-sm"></span>
                </div>
            </div>
            
            <div id="record-notification">¡NUEVO RÉCORD!</div>

            <div id="video-container">
                <video id="webcam-feed" class="w-full shadow-inner" autoplay playsinline></video>
                <div id="movable-rectangle">
                    <div id="detection-val-indicator">Val: 0</div>
                    <div id="handle-tl" class="resize-handle"></div>
                    <div id="handle-br" class="resize-handle"></div>
                </div>
            </div>
            <canvas id="video-canvas"></canvas>
            <div id="video-status" class="text-center text-sm mt-2 text-gray-400 font-semibold">Cargando cámara...</div>
        </div>

        <div class="w-full bg-gray-800 p-4 rounded-xl shadow-lg mb-4">
            <h2 class="text-base font-bold text-cyan-400 neon-text-cyan mb-4 border-b border-gray-700 pb-2">TELEMETRÍA DE CARRERA</h2>
            <div class="telemetry-grid">
                <div class="telemetry-item">
                    <p class="telemetry-label">PILOTO / COCHE</p>
                    <p id="telemetry-pilot-car" class="telemetry-data">N/A / N/A</p>
                </div>
                <div class="telemetry-item">
                    <p class="telemetry-label">ÚLTIMA VUELTA</p>
                    <p id="telemetry-last-lap-time" class="telemetry-data yellow font-mono text-lg">--.---</p>
                </div>
                <div class="telemetry-item">
                    <p class="telemetry-label">MEJOR VUELTA</p>
                    <p id="telemetry-best-time" class="telemetry-data green font-mono text-lg">--.---</p>
                </div>
                <div class="telemetry-item">
                    <p class="telemetry-label">TIEMPO MEDIO</p>
                    <p id="telemetry-average-time" class="telemetry-data font-mono text-lg">--.---</p>
                </div>
                <div class="telemetry-item">
                    <p class="telemetry-label">VELOCIDAD MEDIA (Km/h)</p>
                    <p id="telemetry-avg-speed" class="telemetry-data text-xl text-cyan-300">--.-</p>
                </div>
                <div class="telemetry-item">
                    <p class="telemetry-label">VELOCIDAD MÁXIMA (Km/h)</p>
                    <p id="telemetry-max-speed" class="telemetry-data text-xl text-cyan-300">--.-</p>
                </div>
            </div>
        </div>

        <div class="w-full bg-gray-800 p-4 rounded-xl shadow-lg mb-4">
            <h2 class="text-base font-bold text-cyan-400 neon-text-cyan mb-4 border-b border-gray-700 pb-2">GRÁFICA DE TIEMPOS POR VUELTA</h2>
            <canvas id="lap-graph-canvas"></canvas>
            <p id="graph-status" class="text-center text-sm text-gray-500 mt-2">No hay datos de vueltas para mostrar.</p>
        </div>
    </div>

    <!-- MODAL DE RESULTADOS FINALES NEON -->
    <div id="resultsModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-lg neon-border-box bg-gray-900">
            <div class="text-center mb-6">
                <div class="inline-block p-3 rounded-full bg-gray-800 mb-3 border border-cyan-500 shadow-[0_0_15px_rgba(6,182,212,0.4)]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14h4"/><path d="M12 17v5"/><path d="M21 17.02l.7-4.14a2 2 0 0 0-1.92-2.14H4.22a2 2 0 0 0-1.92 2.14l.7 4.14"/><path d="M15 17H9"/></svg>
                </div>
                <h3 class="text-2xl font-extrabold text-white neon-text-cyan uppercase tracking-wider">
                    ¡Carrera Finalizada!
                </h3>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="col-span-2 bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Piloto / Coche</div>
                    <div id="modal-pilot-car" class="text-white font-bold text-lg truncate"></div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Tiempo Total</div>
                    <div id="modal-total-time" class="text-cyan-300 font-mono font-bold text-lg"></div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="text-green-500"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    </div>
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Mejor Vuelta</div>
                    <div id="modal-best-lap" class="text-green-400 font-mono font-bold text-lg"></div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Media</div>
                    <div id="modal-average-time" class="text-gray-300 font-mono font-bold"></div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Vel. Media</div>
                    <div id="modal-avg-speed" class="text-gray-300 font-bold"></div>
                </div>
            </div>

            <div class="mb-6 bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                <div class="bg-gray-700/50 px-4 py-2 border-b border-gray-700">
                    <h4 class="text-sm font-bold text-cyan-400 uppercase">Detalle de Vueltas</h4>
                </div>
                <div class="max-h-40 overflow-y-auto">
                    <table id="lap-history-table" class="w-full text-sm">
                        <thead class="bg-gray-800 sticky top-0">
                            <tr>
                                <th class="text-gray-500 py-2 px-4">#</th>
                                <th class="text-gray-500 py-2 px-4">Tiempo</th>
                                <th class="text-gray-500 py-2 px-4">Km/h</th>
                            </tr>
                        </thead>
                        <tbody id="lap-history-body" class="text-gray-300 divide-y divide-gray-700">
                            <!-- Inserción dinámica -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <button id="modal-restart-btn" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all duration-200 flex items-center justify-center transform hover:scale-[1.02]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-1.89.26M3 6l.75-2.25M7 3l2.25.75"/></svg>
                VOLVER A EMPEZAR
            </button>
        </div>
    </div>

    <!-- MODAL DE HISTORIAL -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-2xl bg-gray-800 border border-gray-600">
            <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>
                    Historial de Carreras
                </h3>
                <button id="close-history-btn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr>
                            <th class="p-2 text-cyan-400">FECHA</th>
                            <th class="p-2 text-cyan-400">PILOTO/COCHE</th>
                            <th class="p-2 text-cyan-400">MEJOR VUELTA</th>
                            <th class="p-2 text-cyan-400">VEL. MEDIA</th>
                        </tr>
                    </thead>
                    <tbody id="full-history-body" class="text-gray-300">
                        <!-- Historial dinámico -->
                    </tbody>
                </table>
                <p id="no-history-msg" class="text-center text-gray-500 mt-4 hidden">No hay carreras registradas aún.</p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="open-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow flex items-center text-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    Borrar Historial
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACIÓN BORRADO -->
    <div id="confirmModal" class="modal-overlay hidden" style="z-index: 200;">
        <div class="modal-content p-6 w-full max-w-sm bg-gray-800 border border-gray-600 text-center rounded-lg shadow-2xl">
            <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-lg font-bold text-white">¿Borrar Historial?</h3>
                <p class="text-gray-400 text-sm mt-2">Esta acción eliminará todas las carreras guardadas y no se puede deshacer.</p>
            </div>
            <div class="flex justify-center space-x-3">
                <button id="cancel-clear-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors">Cancelar</button>
                <button id="confirm-clear-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold transition-colors">Sí, Borrar</button>
            </div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('webcam-feed');
        const videoContainer = document.getElementById('video-container');
        const movableRectangle = document.getElementById('movable-rectangle');
        const handleTL = document.getElementById('handle-tl');
        const handleBR = document.getElementById('handle-br');
        const cameraOnBtn = document.getElementById('camera-on-btn');
        const cameraOffBtn = document.getElementById('camera-off-btn');
        const videoStatus = document.getElementById('video-status');
        const cameraErrorAlert = document.getElementById('camera-error-alert');
        const cameraErrorText = document.getElementById('camera-error-text');
        const startRaceBtn = document.getElementById('start-race-btn');
        const resetRaceBtn = document.getElementById('reset-race-btn');
        const centralConfigBtn = document.getElementById('central-config-btn');
        const configPanel = document.getElementById('config-panel');
        const resultsModal = document.getElementById('resultsModal');
        const modalRestartBtn = document.getElementById('modal-restart-btn');
        const thresholdSlider = document.getElementById('threshold-slider');
        const currentThresholdDisplay = document.getElementById('current-threshold');
        const trackLengthInput = document.getElementById('track-length-input');
        const lapLimitSelect = document.getElementById('lap-limit-select');
        const pilotNameInput = document.getElementById('pilot-name-input');
        const carModelInput = document.getElementById('car-model-input');
        const telemetryPilotCar = document.getElementById('telemetry-pilot-car');
        const telemetryLastLapTime = document.getElementById('telemetry-last-lap-time');
        const telemetryBestTime = document.getElementById('telemetry-best-time');
        const telemetryAverageTime = document.getElementById('telemetry-average-time');
        const telemetryMaxSpeed = document.getElementById('telemetry-max-speed');
        const telemetryAvgSpeed = document.getElementById('telemetry-avg-speed');
        const lapHistoryBody = document.getElementById('lap-history-body');
        const graphCanvas = document.getElementById('lap-graph-canvas');
        const graphCtx = graphCanvas.getContext('2d');
        const graphStatus = document.getElementById('graph-status');
        
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('historyModal');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const fullHistoryBody = document.getElementById('full-history-body');
        const openConfirmBtn = document.getElementById('open-confirm-btn');
        const noHistoryMsg = document.getElementById('no-history-msg');
        
        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirmModal');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        
        // Voice Toggle & Detection Val
        const voiceToggle = document.getElementById('voice-toggle');
        const detectionValIndicator = document.getElementById('detection-val-indicator');
        const recordNotification = document.getElementById('record-notification');

        let cameraStream = null;
        let isProcessing = false;
        let raceIntervalId = null;
        let lapIntervalId = null;
        let isRaceActive = false;
        let raceStartTime = 0;
        let lapStartTimestamp = 0;
        let currentLap = 0;
        let totalLaps = 10; 
        let finalRaceTimeMs = 0; 
        let isLineBlocked = false;
        let isDetectionReady = false;
        let isDragging = false;
        let isResizing = false;
        let resizeDirection = '';
        let startX, startY;
        let startLeftPct, startTopPct, startWidthPct, startHeightPct;

        let lapHistory = [];
        let bestLapTime = Infinity;
        let totalLapTime = 0;
        let currentAverageTime = 0;
        let maxSpeed = 0.0;
        let avgSpeed = 0.0;
        let lastCompletedLapTime = 0;
        let lastRecordTime = 0; // Min Lap Time protection

        const soundOptions = [
            { name: "Beep Clásico", freq: 600, dur: 0.1 },
            { name: "Tono Grave", freq: 400, dur: 0.2 },
            { name: "Beep Agudo", freq: 900, dur: 0.08 },
            { name: "Pito Corto", freq: 1200, dur: 0.05 }
        ];
        let selectedSoundIndex = 0; 

        const synth = new Tone.Synth().toDestination();
        const startTone = new Tone.PolySynth(Tone.Synth, { 
            oscillator: { type: "sine" }, 
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } 
        }).toDestination();

        // ----------------------------------------------------
        // --- FUNCIÓN DE VOZ (SPEECH SYNTHESIS) ---
        // ----------------------------------------------------
        let currentUtterance = null;

        function announceLap(lapNumber, timeMs, isBest, extraMessage = "") {
            if (!voiceToggle.checked) return;
            
            if (lapNumber <= 0) return; 

            const seconds = Math.floor(timeMs / 1000);
            const decimals = (timeMs % 1000).toString().padStart(3, '0');
            
            let textToSpeak = `${seconds} punto ${decimals}`;

            if (isBest && lapNumber > 1) {
                textToSpeak = `¡Vuelta rápida! ${textToSpeak}`;
            }

            if (extraMessage) {
                textToSpeak += `. ${extraMessage}`;
            }

            window.speechSynthesis.cancel(); 
            
            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            currentUtterance.lang = 'es-ES';
            currentUtterance.rate = 1.2; 
            window.speechSynthesis.speak(currentUtterance);
        }

        function announceRaceFinish(pilotName) {
            if (!voiceToggle.checked) return;
            // No cancelamos para dejar que termine de hablar si había algo en cola
            
            const utterance = new SpeechSynthesisUtterance(`Carrera finalizada. Buen trabajo ${pilotName}.`);
            utterance.lang = 'es-ES';
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
        
        function showRecordNotification() {
            recordNotification.classList.add('show');
            setTimeout(() => {
                recordNotification.classList.remove('show');
            }, 2000);
        }

        function getClientCoords(e) {
            return {
                x: e.touches ? e.touches[0].clientX : e.clientX,
                y: e.touches ? e.touches[0].clientY : e.clientY
            };
        }

        function playSound(frequency, duration) {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            synth.triggerAttackRelease(frequency, duration);
        }
        
        function playFinalLapSound() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            // Sonido de alarma distintivo (doble pitido rápido y agudo)
            const now = Tone.now();
            synth.triggerAttackRelease("G5", "16n", now);
            synth.triggerAttackRelease("G5", "16n", now + 0.1);
            synth.triggerAttackRelease("C6", "8n", now + 0.2);
        }

        function toggleConfigPanel() {
            configPanel.classList.toggle('open');
            centralConfigBtn.classList.toggle('bg-gray-700/70');
            centralConfigBtn.classList.toggle('bg-gray-900');
        }

        function updateLapLimit() {
            const selectedValue = lapLimitSelect.value;
            totalLaps = selectedValue === 'Infinity' ? Infinity : parseInt(selectedValue, 10);
            const displayLimit = selectedValue === 'Infinity' ? '∞' : totalLaps;
            document.getElementById('lap-count').textContent = `VUELTA: ${currentLap} / ${displayLimit}`;
        }
        
        function updateCameraButtons(isPlaying) {
            cameraOnBtn.disabled = isPlaying || isRaceActive;
            cameraOffBtn.disabled = !isPlaying;
            centralConfigBtn.disabled = isRaceActive; 
        }

        async function startWebcam() {
            if (cameraStream) return;
            videoStatus.textContent = 'Intentando iniciar cámara...';
            cameraErrorAlert.classList.add('hidden');
            cameraOnBtn.disabled = true;

            const canvas = document.getElementById('video-canvas');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { exact: "environment" } } 
                });
                cameraStream = stream;
                videoElement.srcObject = stream;
                
                videoElement.onloadedmetadata = function() {
                    videoElement.play().then(() => {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        isProcessing = true;
                        processVideo();
                        videoStatus.textContent = 'Cámara activa. ROI listo para ajustar.';
                        videoStatus.classList.remove('text-yellow-400', 'text-red-400');
                        videoStatus.classList.add('text-green-400');
                        updateCameraButtons(true);
                        movableRectangle.style.display = 'block';
                    }).catch(error => {
                        videoStatus.textContent = '¡Video bloqueado! Click en el icono verde para iniciar.';
                        videoStatus.classList.add('text-red-400');
                        cameraOnBtn.disabled = false;
                    });
                };
            } catch (err) {
                let errorMessage = `Error: ${err.name} - Acceso denegado o no disponible.`;
                try {
                     const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                     cameraStream = stream;
                     videoElement.srcObject = stream;
                     
                     videoElement.onloadedmetadata = function() {
                        videoElement.play().then(() => {
                            canvas.width = videoElement.videoWidth;
                            canvas.height = videoElement.videoHeight;
                            isProcessing = true;
                            processVideo();
                            videoStatus.textContent = 'Cámara activa. ROI listo para ajustar.';
                            videoStatus.classList.remove('text-yellow-400', 'text-red-400');
                            videoStatus.classList.add('text-green-400');
                            updateCameraButtons(true);
                            movableRectangle.style.display = 'block';
                        }).catch(error => {
                            videoStatus.textContent = '¡Video bloqueado! Click en el icono verde para iniciar.';
                            videoStatus.classList.add('text-red-400');
                            cameraOnBtn.disabled = false;
                        });
                    };
                } catch (defaultErr) {
                    errorMessage = `Error: ${defaultErr.name} - Acceso a cámara denegado o no disponible.`;
                    cameraErrorText.textContent = errorMessage;
                    cameraErrorAlert.classList.remove('hidden');
                    videoStatus.textContent = 'ERROR al iniciar la cámara.';
                    videoStatus.classList.add('text-red-400');
                    updateCameraButtons(false);
                    cameraOnBtn.disabled = false;
                }
            }
        }

        function stopWebcam() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                cameraStream = null;
                isProcessing = false;
                videoStatus.textContent = 'Cámara apagada por el usuario.';
                videoStatus.classList.add('text-red-400');
                movableRectangle.style.display = 'none';
            }
            updateCameraButtons(false);
        }

        function getROIBrightness() {
            const videoWidth = videoElement.videoWidth;
            const videoHeight = videoElement.videoHeight;
            const roiLeftPct = getRoiPercentage('left');
            const roiTopPct = getRoiPercentage('top');
            const roiWidthPct = getRoiPercentage('width');
            const roiHeightPct = getRoiPercentage('height');
            const roiLeft = Math.floor(videoWidth * (roiLeftPct / 100));
            const roiTop = Math.floor(videoHeight * (roiTopPct / 100));
            const roiWidth = Math.ceil(videoWidth * (roiWidthPct / 100));
            const roiHeight = Math.ceil(videoHeight * (roiHeightPct / 100));
            const canvas = document.getElementById('video-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(videoElement, 0, 0, videoWidth, videoHeight);
            
            try {
                const imageData = ctx.getImageData(roiLeft, roiTop, roiWidth, roiHeight);
                const data = imageData.data;
                let totalBrightness = 0;
                const pixelCount = roiWidth * roiHeight;
                
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    totalBrightness += brightness;
                }
                return totalBrightness / pixelCount;
            } catch (e) {
                return 0;
            }
        }

        function processVideo() {
            if (!isProcessing || videoElement.paused || videoElement.ended) return;
            const brightness = getROIBrightness();
            const threshold = parseInt(thresholdSlider.value, 10);
            
            detectionValIndicator.textContent = `Brillo: ${brightness.toFixed(0)}`;
            
            const lineCrossed = brightness < threshold; 
            
            if (lineCrossed) {
                movableRectangle.classList.add('roi-detected');
            } else {
                movableRectangle.classList.remove('roi-detected');
            }
            
            if (isRaceActive && isDetectionReady) {
                handleDetection(lineCrossed);
            }
            requestAnimationFrame(processVideo);
        }

        function handleDetection(isCurrentlyBlocked) {
            if (isCurrentlyBlocked && !isLineBlocked) {
                isLineBlocked = true;
                recordLap(); 
            }
            else if (!isCurrentlyBlocked && isLineBlocked) {
                isLineBlocked = false;
            }
        }

        function formatTime(ms, isRaceTime = false) {
            if (ms === Infinity || ms <= 0) return isRaceTime ? "00:00.000" : "--.---";
            const milliseconds = String(ms % 1000).padStart(3, '0');
            const totalSeconds = Math.floor(ms / 1000);
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            if (isRaceTime) {
                const totalMinutes = Math.floor(totalSeconds / 60);
                const minutes = String(totalMinutes).padStart(2, '0');
                return `${minutes}:${seconds}.${milliseconds}`;
            } else {
                return `${seconds}.${milliseconds}`;
            }
        }

        function calculateSpeed(lapTimeMs) {
            const trackLengthMeters = parseFloat(trackLengthInput.value);
            if (isNaN(trackLengthMeters) || lapTimeMs <= 0) return 0.0;
            const timeInSeconds = lapTimeMs / 1000;
            const speedMetersPerSecond = trackLengthMeters / timeInSeconds;
            const CONSTANT_MS_TO_KMH = 3.6; 
            let speedKmH = speedMetersPerSecond * CONSTANT_MS_TO_KMH;
            return speedKmH;
        }
        
        function updateTelemetryDisplay() {
            telemetryPilotCar.textContent = `${pilotNameInput.value || 'N/A'} / ${carModelInput.value || 'N/A'}`;
            telemetryLastLapTime.textContent = lastCompletedLapTime === 0 ? "--.---" : formatTime(lastCompletedLapTime, false);
            telemetryBestTime.textContent = bestLapTime === Infinity ? "--.---" : formatTime(bestLapTime, false);
            telemetryAverageTime.textContent = currentAverageTime === 0 ? "--.---" : formatTime(currentAverageTime, false);
            telemetryMaxSpeed.textContent = maxSpeed.toFixed(1);
            telemetryAvgSpeed.textContent = avgSpeed.toFixed(1);
            drawLapGraph();
        }

        function startTimers() {
            if (raceIntervalId) clearInterval(raceIntervalId);
            raceStartTime = Date.now() - (currentLap > 0 ? totalLapTime : 0); 
            raceIntervalId = setInterval(() => {
                finalRaceTimeMs = Date.now() - raceStartTime;
                document.getElementById('race-time').textContent = formatTime(finalRaceTimeMs, true);
            }, 50);

            if (lapIntervalId) clearInterval(lapIntervalId);
            lapStartTimestamp = Date.now();
            lapIntervalId = setInterval(() => {
                const elapsedLap = Date.now() - lapStartTimestamp;
                document.getElementById('lap-time').textContent = formatTime(elapsedLap, false);
            }, 10);
        }

        function calculateStats(newLapTimeMs, newLapSpeed) {
            const isBest = newLapTimeMs < bestLapTime;
            
            if (isBest) {
                bestLapTime = newLapTimeMs;
            }
            totalLapTime = lapHistory.reduce((sum, lap) => sum + lap.time, 0);
            currentAverageTime = Math.round(totalLapTime / lapHistory.length);
            if (newLapSpeed > maxSpeed) {
                maxSpeed = newLapSpeed;
            }
            let totalSpeedSum = lapHistory.reduce((sum, lap) => sum + lap.speed, 0);
            avgSpeed = totalSpeedSum / lapHistory.length;
            
            updateTelemetryDisplay();
            return isBest; 
        }

        function recordLap() {
            if (!isRaceActive) return; 
            
            // MIN LAP TIME PROTECTION (3000ms) - Anti-Rebote START Protection
            const now = Date.now();
            // Si la carrera acaba de empezar (menos de 3 segundos), ignorar detección
            if (now - raceStartTime < 3000) {
                 return; 
            }
            // Si la última vuelta fue hace menos de 3 segundos, ignorar (anti-rebote normal)
            if (now - lastRecordTime < 3000) return;
            lastRecordTime = now;

            const completedLapTime = now - lapStartTimestamp;
            const lapSpeed = calculateSpeed(completedLapTime);
            
            const lapData = {
                lap: currentLap + 1, 
                time: completedLapTime,
                speed: lapSpeed
            };
            lapHistory.push(lapData);
            lastCompletedLapTime = completedLapTime;
            
            const isBestLap = calculateStats(completedLapTime, lapSpeed);

            // Incrementar contador de vuelta ANTES de verificar final o mensajes
            currentLap++; 

            // Logica para mensajes de estado de carrera (5 vueltas, 1 vuelta)
            let raceStatusMessage = "";
            let remainingLaps = Infinity;
            
            if (totalLaps !== Infinity) {
                remainingLaps = totalLaps - currentLap;
                
                if (remainingLaps === 5) {
                    raceStatusMessage = "Atención, quedan 5 vueltas.";
                } else if (remainingLaps === 0) { // Estamos en la última vuelta si quedan 0 para acabar al final de esta? No, remainingLaps es cuantas quedan POR HACER despues de la actual.
                     // Si currentLap acaba de incrementarse. Ejemplo Total 10.
                     // Acaba vuelta 9. currentLap pasa a 10. 
                     // Queda LA ULTIMA vuelta (la 10).
                     // Entonces remainingLaps = 10 - 10 = 0.
                     // ERROR LOGICO ARRIBA: currentLap es la que ESTÁ CORRIENDO o la que ACABA DE TERMINAR?
                     // En este código currentLap empieza en 0.
                     // Al acabar la primera vuelta, currentLap se pone a 1.
                     // Si total es 10.
                     // Acaba vuelta 9. currentLap = 9.
                     // remaining = 10 - 9 = 1. -> ULTIMA VUELTA
                     
                     // Vamos a revisar la logica original:
                     // currentLap++; se ejecuta antes.
                     // Si acaba vuelta 9. currentLap se hace 10.
                     // La vuelta 10 es la ultima.
                     // Pero el usuario esta "corriendo" la vuelta 10 ahora.
                     // Entonces remaining = 10 - 10 = 0?
                     // NO, si currentLap es 10, y totalLaps es 10, significa que HA COMPLETADO 10 vueltas. LA CARRERA ACABA.
                     
                     // RECTIFICACION:
                     // Si quiero avisar que EMPIEZA la ultima vuelta.
                     // Total 10.
                     // Acaba vuelta 9. currentLap pasa a 9 (si empezamos en 0 y sumamos al acabar).
                     // Ojo, en el codigo original: currentLap++ está al final.
                     // Yo lo moví arriba.
                     // Si currentLap (vueltas completadas) es 9. Entra a meta.
                     // currentLap pasa a 10.
                     // 10 >= 10 -> FIN DE CARRERA.
                     
                     // Entonces el aviso de "Ultima Vuelta" debe ser cuando:
                     // Acaba vuelta 8. currentLap pasa a 9.
                     // El usuario empieza la vuelta 9... no, la vuelta 10 es la ultima.
                     // Si total es 10. La vuelta 10 es la ultima.
                     // Al acabar la 9, empieza la 10.
                     // Al acabar la 9, currentLap (completadas) pasa a 9.
                     // Total (10) - Completadas (9) = 1. -> Queda 1 vuelta (la 10).
                     // CORRECTO.
                }
            }

            // Recalculamos remaining con el nuevo currentLap
            if (totalLaps !== Infinity) {
                const lapsDone = currentLap; 
                const lapsLeft = totalLaps - lapsDone;
                
                if (lapsLeft === 5) {
                    raceStatusMessage = "Quedan 5 vueltas.";
                } else if (lapsLeft === 1) {
                    raceStatusMessage = "¡Última vuelta! A fondo.";
                    playFinalLapSound(); // Sonido especial alarma
                }
            }

            // Sonido normal de paso por meta (si no es la ultima vuelta que ya tiene su sonido, o si quieres ambos)
            // Vamos a poner el sonido normal siempre, y el de alarma se suma si es la ultima
            const sound = soundOptions[selectedSoundIndex];
            playSound(sound.freq, sound.dur);
            
            // Voz SIEMPRE en cada vuelta, adjuntando mensaje especial si lo hay
            announceLap(currentLap, completedLapTime, isBestLap, raceStatusMessage);
            
            if (isBestLap && currentLap > 0) {
                showRecordNotification();
            }
            
            const recordedTimeFormatted = formatTime(completedLapTime, false);
            document.getElementById('lap-time').textContent = recordedTimeFormatted;
            
            // Comprobar final de carrera
            if (totalLaps !== Infinity && currentLap >= totalLaps) {
                stopRace(true); 
                return;
            }

            // Resetear crono para siguiente vuelta
            lapStartTimestamp = Date.now();
            const displayLimit = totalLaps === Infinity ? '∞' : totalLaps;
            // Mostrar vueltas COMPLETADAS
            document.getElementById('lap-count').textContent = `VUELTA: ${currentLap} / ${displayLimit}`;
            document.getElementById('lap-time').classList.remove('text-red-400');
            document.getElementById('lap-time').classList.add('text-green-400');
        }

        function saveRaceToHistory() {
            const raceRecord = {
                date: new Date().toLocaleString(),
                pilot: pilotNameInput.value || 'Desconocido',
                car: carModelInput.value || 'Desconocido',
                bestLap: bestLapTime === Infinity ? '--.--' : formatTime(bestLapTime, false),
                avgSpeed: avgSpeed.toFixed(1),
                laps: currentLap
            };

            let history = JSON.parse(localStorage.getItem('scx_history') || '[]');
            history.unshift(raceRecord);
            if (history.length > 50) history.pop();
            
            localStorage.setItem('scx_history', JSON.stringify(history));
        }

        function loadAndRenderHistory() {
            const history = JSON.parse(localStorage.getItem('scx_history') || '[]');
            fullHistoryBody.innerHTML = '';

            if (history.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                noHistoryMsg.classList.add('hidden');
                history.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-700 hover:bg-gray-700/50";
                    tr.innerHTML = `
                        <td class="p-2 text-gray-400 text-xs">${record.date}</td>
                        <td class="p-2 font-bold text-white">${record.pilot} <br><span class="text-xs text-gray-500 font-normal">${record.car}</span></td>
                        <td class="p-2 font-mono text-green-400">${record.bestLap}</td>
                        <td class="p-2 text-cyan-300 font-mono">${record.avgSpeed} Km/h</td>
                    `;
                    fullHistoryBody.appendChild(tr);
                });
            }
        }

        openConfirmBtn.addEventListener('click', () => {
            confirmModal.classList.remove('hidden');
            setTimeout(() => confirmModal.classList.add('open'), 10);
        });

        cancelClearBtn.addEventListener('click', () => {
            confirmModal.classList.remove('open');
            setTimeout(() => confirmModal.classList.add('hidden'), 300);
        });

        confirmClearBtn.addEventListener('click', () => {
            localStorage.removeItem('scx_history');
            loadAndRenderHistory();
            confirmModal.classList.remove('open');
            setTimeout(() => confirmModal.classList.add('hidden'), 300);
        });

        historyBtn.addEventListener('click', () => {
            loadAndRenderHistory();
            historyModal.classList.remove('hidden');
            setTimeout(() => historyModal.classList.add('open'), 10);
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.remove('open');
            setTimeout(() => historyModal.classList.add('hidden'), 300);
        });

        function stopRace(isFinished = false) {
            isRaceActive = false;
            isDetectionReady = false;
            if (raceIntervalId) clearInterval(raceIntervalId);
            if (lapIntervalId) clearInterval(lapIntervalId);
            raceIntervalId = null;
            lapIntervalId = null;

            lights.forEach(light => light.classList.remove('red', 'green'));
            
            const displayLimit = totalLaps === Infinity ? '∞' : totalLaps;

            if (isFinished) {
                saveRaceToHistory();
                
                announceRaceFinish(pilotNameInput.value || "Piloto");

                document.getElementById('lap-time').textContent = bestLapTime === Infinity ? "--.---" : formatTime(bestLapTime, false);
                document.getElementById('lap-time').classList.remove('text-green-400');
                document.getElementById('lap-time').classList.add('text-red-400');
                document.getElementById('lap-count').textContent = `VUELTA: ${totalLaps} / ${displayLimit} (FINALIZADA)`;
                
                document.getElementById('modal-pilot-car').textContent = `${pilotNameInput.value} / ${carModelInput.value}`;
                document.getElementById('modal-total-time').textContent = formatTime(finalRaceTimeMs, true);
                document.getElementById('modal-best-lap').textContent = bestLapTime === Infinity ? "--.---" : formatTime(bestLapTime, false);
                document.getElementById('modal-average-time').textContent = formatTime(currentAverageTime, false);
                document.getElementById('modal-avg-speed').textContent = `${avgSpeed.toFixed(1)} Km/h`;
                
                const lapHistoryTableBody = document.getElementById('lap-history-body');
                lapHistoryTableBody.innerHTML = ''; 
                lapHistory.forEach(lap => {
                    const isBest = lap.time === bestLapTime;
                    const row = document.createElement('tr');
                    row.className = isBest ? 'bg-green-900/50' : ''; 
                    row.innerHTML = `
                        <td class="py-2 px-4">${lap.lap}</td>
                        <td class="py-2 px-4 ${isBest ? 'text-green-400 font-bold' : ''}">${(lap.time / 1000).toFixed(3)}</td>
                        <td class="py-2 px-4">${lap.speed.toFixed(1)}</td>
                    `;
                    lapHistoryTableBody.appendChild(row);
                });

                showResultsModal();

            } else {
                currentLap = 0;
                lapHistory = [];
                bestLapTime = Infinity;
                totalLapTime = 0;
                currentAverageTime = 0;
                maxSpeed = 0.0;
                avgSpeed = 0.0;
                lastCompletedLapTime = 0;
                lastRecordTime = 0; 
                
                document.getElementById('race-time').textContent = "00:00.000";
                document.getElementById('lap-time').textContent = "00.000";
                document.getElementById('lap-time').classList.remove('text-red-400');
                document.getElementById('lap-time').classList.add('text-green-400');
                document.getElementById('lap-count').textContent = `VUELTA: 0 / ${displayLimit}`;
                
                updateTelemetryDisplay();
            }
            startRaceBtn.disabled = false;
            resetRaceBtn.disabled = true;
            centralConfigBtn.disabled = false;
        }

        const lights = [1, 2, 3, 4, 5].map(i => document.getElementById(`light-${i}`));

        async function startTrafficLight() {
            // WARM-UP DEL AUDIO: Disparamos un texto vacío para activar el motor de voz
            if (voiceToggle.checked) {
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                }
                const warmUpUtterance = new SpeechSynthesisUtterance("");
                window.speechSynthesis.speak(warmUpUtterance);
            }

            isRaceActive = true;
            configPanel.classList.remove('open'); 
            centralConfigBtn.disabled = true;
            startRaceBtn.disabled = true;
            resetRaceBtn.disabled = true;
            updateCameraButtons(!!cameraStream);
            
            lights.forEach(light => light.classList.remove('red', 'green'));
            
            const redLights = lights.slice(0, 4);
            for (let i = 0; i < redLights.length; i++) {
                redLights[i].classList.add('red');
                synth.triggerAttackRelease("C4", "8n");
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            const randomDelay = Math.random() * 1000 + 500; 
            await new Promise(resolve => setTimeout(resolve, randomDelay));

            redLights.forEach(light => light.classList.remove('red'));
            lights.forEach(light => light.classList.add('green')); 
            
            startTone.triggerAttackRelease(["C5", "E5", "G5"], "4n");

            isDetectionReady = true; 
            startTimers(); 
            resetRaceBtn.disabled = false;
        }

        function drawLapGraph() {
            const containerWidth = graphCanvas.parentElement.offsetWidth - 32; 
            graphCanvas.width = containerWidth;
            graphCanvas.height = 200; 

            if (lapHistory.length === 0) {
                graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
                graphStatus.textContent = "No hay datos de vueltas para mostrar.";
                return;
            }
            
            graphStatus.textContent = "";

            const data = lapHistory.map(lap => lap.time);
            const maxTime = Math.max(...data);
            const minTime = Math.min(...data);

            const padding = 20; 
            const graphWidth = graphCanvas.width - 2 * padding;
            const graphHeight = graphCanvas.height - 2 * padding;
            const barCount = data.length;
            const barSpacing = 10;
            const barWidth = (graphWidth - (barCount - 1) * barSpacing) / barCount;
            
            graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);

            graphCtx.strokeStyle = '#334155'; 
            graphCtx.lineWidth = 1;
            graphCtx.beginPath();
            graphCtx.moveTo(padding, graphCanvas.height - padding);
            graphCtx.lineTo(graphCanvas.width - padding, graphCanvas.height - padding);
            graphCtx.moveTo(padding, padding);
            graphCtx.lineTo(padding, graphCanvas.height - padding);
            graphCtx.stroke();

            data.forEach((time, index) => {
                const x = padding + index * (barWidth + barSpacing);
                const timeRange = maxTime - minTime;
                let barHeight;
                if (data.length === 1 || timeRange === 0) {
                    barHeight = graphHeight * 0.7;
                } else {
                    barHeight = graphHeight * (1 - (time - minTime) / timeRange) * 0.8 + graphHeight * 0.2;
                }
                
                const y = graphCanvas.height - padding - barHeight;
                let color;
                const isBestLap = time === bestLapTime;
                if (isBestLap) {
                    color = '#10b981'; 
                } else if (index === data.length - 1) {
                    color = '#facc15'; 
                } else {
                    color = '#06b6d4'; 
                }

                graphCtx.fillStyle = color;
                graphCtx.fillRect(x, y, barWidth, barHeight);
                graphCtx.shadowColor = color;
                graphCtx.shadowBlur = 5;
                graphCtx.fillStyle = color;
                graphCtx.fillRect(x, y, barWidth, barHeight);
                graphCtx.shadowBlur = 0; 

                graphCtx.fillStyle = '#94a3b8'; 
                graphCtx.font = '10px Inter';
                graphCtx.textAlign = 'center';
                graphCtx.fillText(index + 1, x + barWidth / 2, graphCanvas.height - 5);

                graphCtx.fillStyle = '#cbd5e1'; 
                if (isBestLap) {
                    graphCtx.fillStyle = '#10b981'; 
                }
                graphCtx.font = '12px Inter';
                graphCtx.textAlign = 'center';
                const timeInSeconds = (time / 1000).toFixed(3);
                graphCtx.fillText(timeInSeconds, x + barWidth / 2, y - 5);
            });
        }
        
        function showResultsModal() {
            resultsModal.classList.remove('hidden');
            setTimeout(() => {
                resultsModal.classList.add('open');
            }, 10);
        }

        function getRoiPercentage(propName) {
            const style = movableRectangle.style[propName];
            return style ? parseFloat(style.replace('%', '')) : 0;
        }

        function startAction(e, actionType, direction = '') {
            if (movableRectangle.style.display === 'none' || isRaceActive) return;

            e.preventDefault();
            const coords = getClientCoords(e);
            startX = coords.x;
            startY = coords.y;
            startLeftPct = getRoiPercentage('left');
            startTopPct = getRoiPercentage('top');
            startWidthPct = getRoiPercentage('width');
            startHeightPct = getRoiPercentage('height');
            movableRectangle.style.transition = 'none';

            if (e.pointerId !== undefined) {
                e.target.setPointerCapture(e.pointerId);
            }

            if (actionType === 'drag') {
                isDragging = true;
                movableRectangle.classList.add('dragging');
            } else if (actionType === 'resize') {
                isResizing = true;
                resizeDirection = direction;
                document.body.classList.add('resizing-nwse');
            }

            document.addEventListener('pointermove', moveAction);
            document.addEventListener('pointerup', endAction);
            document.addEventListener('pointercancel', endAction);
        }

        function moveAction(e) {
            if (!isDragging && !isResizing) return;
            e.preventDefault();

            const coords = getClientCoords(e);
            const dx = coords.x - startX;
            const dy = coords.y - startY;
            const videoRect = videoContainer.getBoundingClientRect();
            const dxPct = (dx / videoRect.width) * 100;
            const dyPct = (dy / videoRect.height) * 100;
            const minSizePct = 5;

            if (isDragging) {
                let newLeftPct = startLeftPct + dxPct;
                let newTopPct = startTopPct + dyPct;
                newLeftPct = Math.max(0, Math.min(newLeftPct, 100 - startWidthPct));
                newTopPct = Math.max(0, Math.min(newTopPct, 100 - startHeightPct));
                movableRectangle.style.left = `${newLeftPct}%`;
                movableRectangle.style.top = `${newTopPct}%`;
            } else if (isResizing) {
                if (resizeDirection === 'tl') {
                    let newLeftPct = startLeftPct + dxPct;
                    let newTopPct = startTopPct + dyPct;
                    let newWidthPct = startWidthPct - dxPct;
                    let newHeightPct = startHeightPct - dyPct;
                    if (newWidthPct >= minSizePct && newLeftPct >= 0) {
                        movableRectangle.style.left = `${newLeftPct}%`;
                        movableRectangle.style.width = `${newWidthPct}%`;
                    } else if (newWidthPct < minSizePct) {
                        movableRectangle.style.left = `${startLeftPct + startWidthPct - minSizePct}%`;
                        movableRectangle.style.width = `${minSizePct}%`;
                    }
                    if (newHeightPct >= minSizePct && newTopPct >= 0) {
                        movableRectangle.style.top = `${newTopPct}%`;
                        movableRectangle.style.height = `${newHeightPct}%`;
                    } else if (newHeightPct < minSizePct) {
                        movableRectangle.style.height = `${minSizePct}%`;
                        movableRectangle.style.top = `${startTopPct + startHeightPct - minSizePct}%`;
                    }
                } else if (resizeDirection === 'br') {
                    let newWidthPct = startWidthPct + dxPct;
                    let newHeightPct = startHeightPct + dyPct;
                    if (newWidthPct >= minSizePct && (startLeftPct + newWidthPct) <= 100) {
                        movableRectangle.style.width = `${newWidthPct}%`;
                    } else if (newWidthPct < minSizePct) {
                        movableRectangle.style.width = `${minSizePct}%`;
                    }
                    if (newHeightPct >= minSizePct && (startTopPct + newHeightPct) <= 100) {
                        movableRectangle.style.height = `${newHeightPct}%`;
                    } else if (newHeightPct < minSizePct) {
                        movableRectangle.style.height = `${minSizePct}%`;
                    }
                }
            }
        }

        function endAction(e) {
            if (isDragging || isResizing) {
                if (e.target.hasPointerCapture(e.pointerId)) {
                    e.target.releasePointerCapture(e.pointerId);
                }
                movableRectangle.style.transition = 'all 0.1s ease';
                isDragging = false;
                isResizing = false;
                resizeDirection = '';
                movableRectangle.classList.remove('dragging');
                document.body.classList.remove('resizing-nwse');
                document.removeEventListener('pointermove', moveAction);
                document.removeEventListener('pointerup', endAction);
                document.removeEventListener('pointercancel', endAction);
            }
        }

        movableRectangle.addEventListener('pointerdown', (e) => {
            if (e.target.classList.contains('resize-handle')) return; 
            startAction(e, 'drag');
        });

        handleTL.addEventListener('pointerdown', (e) => {
            if (isRaceActive) return;
            startAction(e, 'resize', 'tl');
        });

        handleBR.addEventListener('pointerdown', (e) => {
            if (isRaceActive) return;
            startAction(e, 'resize', 'br');
        });
        
        startRaceBtn.addEventListener('click', startTrafficLight);
        resetRaceBtn.addEventListener('click', () => stopRace(false));
        centralConfigBtn.addEventListener('click', toggleConfigPanel);
        
        modalRestartBtn.addEventListener('click', () => {
            resultsModal.classList.remove('open');
            setTimeout(() => {
                resultsModal.classList.add('hidden');
                stopRace(false); 
            }, 300); 
        });
        
        lapLimitSelect.addEventListener('change', updateLapLimit);
        
        thresholdSlider.addEventListener('input', () => {
            currentThresholdDisplay.textContent = thresholdSlider.value;
        });

        cameraOnBtn.addEventListener('click', startWebcam);
        cameraOffBtn.addEventListener('click', stopWebcam);

        window.onload = function() {
            if (!movableRectangle.style.left) movableRectangle.style.left = '25%';
            if (!movableRectangle.style.top) movableRectangle.style.top = '25%';
            if (!movableRectangle.style.width) movableRectangle.style.width = '50%';
            if (!movableRectangle.style.height) movableRectangle.style.height = '50%';
            
            movableRectangle.style.display = 'block'; 
            updateCameraButtons(false);
            lapLimitSelect.value = '10'; 
            updateLapLimit(); 
            stopRace(false); 
            currentThresholdDisplay.textContent = thresholdSlider.value;
            drawLapGraph();

            const soundSelect = document.getElementById('soundSelect');
            soundSelect.value = selectedSoundIndex.toString(); 
            soundSelect.addEventListener('change', (e) => {
                selectedSoundIndex = parseInt(e.target.value); 
                const sound = soundOptions[selectedSoundIndex];
                playSound(sound.freq, sound.dur);
            });

            startWebcam(); 
        };
        
    </script>
</body>
</html>
